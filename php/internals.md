# PHP Internals

## Zval

Структура данных zval (сокращение от "Zend value") используется для представления любых значений PHP. Это одна из самых важных структур во всем PHP и вы будете много работать с ней. Этот раздел описаывет базовые концепции лежащие в основе zval-ов и способы их использования.

## Типы и значения

Кроме всего прочего, каждый zval хранит некоторое значение и тип этого значения. Это необходимо потому что PHP — это язык с динамической типизацией и поэтому тип переменных известен только во время выполнения программы (run-time), а не во время компиляции (compile-time). Кроме того, тип переменной может быть изменен в течение жизни zval, то есть zval ранее хранимый как целое число (integer) позднее может содержать строку (string).

Тип переменной хранится как целочисленная метка (type tag, unsigned char). Метка может принимать одно из 8 значений, которое соответствует 8 типам данных доступных в PHP. Эти значения должны присваиваться с использованием констант вида `IS_TYPE`. Например, `IS_NULL`соответствует типу данных null, а `IS_STRING` — строке.

Фактическое значение переменной хранится в типе данных union (*"объединение", в дальнейшем я буду использовать термины union или юнион — примечание переводчика*), который определен следующим образом:

```
typedef union _zvalue_value {
    long lval;
    double dval;
    struct {
        char *val;
        int len;
    } str;
    HashTable *ht;
    zend_object_value obj;
} zvalue_value;

```

Небольшое пояснение для тех кто не знаком с концепцией union-ов. Union определяет несколько членов-данных различных типов, но в каждый момент времени может использоваться только одно значение из определенных в юнионе. Например, если члену данных `value.lval` было присвоено значение, то для доступа к данным вы можете использовать только `value.lval`, доступ к другим членам данных недопустим и может приводить к непредсказуемому поведению программы. Причина этого в том, что юнионы хранят данные всех своих членов в одной области памяти и интерпретируют значение по разному исходя из имени, к которому вы обращаетесь. Размер памяти, выделяемой для юниона, соответствует размеру самого большого его члена-данных.



## Устройство массивов

PHP5

PHP7

## Устройство объектов

PHP5

PHP7

***Дополнительно:***

http://www.phpinternalsbook.com/

https://romka.gitbooks.io/php-internals-book-ru/

https://habr.com/company/mailru/blog/310054/

https://habr.com/company/mailru/blog/311068/

https://habr.com/company/mailru/blog/318008/